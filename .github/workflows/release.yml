name: Release

on:
  workflow_dispatch:

permissions:
  contents: write
  id-token: write

concurrency:
  group: release
  cancel-in-progress: false

jobs:
  version:
    name: Validate & Read Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - uses: jdx/mise-action@v2
        with:
          install_args: rust nodejs python just

      - name: Validate ref is a tag
        run: |
          if [[ ! "$GITHUB_REF" == refs/tags/v* ]]; then
            echo "::error::This workflow must be dispatched from a tag (e.g. v0.3.1), not a branch."
            exit 1
          fi

      - name: Extract version from tag
        id: version
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Release version: $VERSION"

      - name: Verify all package versions match tag
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          ERRORS=0
          while IFS='=' read -r component ver; do
            if [ "$ver" != "$VERSION" ]; then
              echo "::error::$component version ($ver) != tag ($VERSION)"
              ERRORS=$((ERRORS + 1))
            fi
          done < <(just versions)
          if [ "$ERRORS" -gt 0 ]; then
            echo "::error::$ERRORS package(s) have mismatched versions. Run 'just release <version>' to sync."
            exit 1
          fi
          echo "All package versions match tag: $VERSION"

  create-release:
    name: Create Draft Release
    needs: version
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Create draft release (idempotent)
        run: |
          if gh release view "v${{ needs.version.outputs.version }}" >/dev/null 2>&1; then
            echo "Release v${{ needs.version.outputs.version }} already exists, skipping"
          else
            gh release create "v${{ needs.version.outputs.version }}" \
              --draft \
              --generate-notes \
              --title "v${{ needs.version.outputs.version }}"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-binaries:
    name: Build (${{ matrix.target }})
    needs: create-release
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            runner: ubuntu-latest
            artifact: hron-linux-x86_64
          - target: x86_64-apple-darwin
            runner: macos-latest
            artifact: hron-macos-x86_64
          - target: aarch64-apple-darwin
            runner: macos-latest
            artifact: hron-macos-aarch64
    steps:
      - uses: actions/checkout@v4

      - uses: jdx/mise-action@v2
        with:
          install_args: rust

      - name: Add target
        run: rustup target add ${{ matrix.target }}

      - name: Build release binary
        run: cargo build --release --package hron-cli --target ${{ matrix.target }}
        working-directory: rust

      - name: Package artifact
        run: |
          mkdir staging
          cp rust/target/${{ matrix.target }}/release/hron staging/
          tar -czf ${{ matrix.artifact }}.tar.gz -C staging hron

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: ${{ matrix.artifact }}.tar.gz

  upload-assets:
    name: Upload Release Assets
    needs: [version, build-binaries]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Upload assets to release
        run: |
          gh release upload "v${{ needs.version.outputs.version }}" \
            dist/hron-linux-x86_64/hron-linux-x86_64.tar.gz \
            dist/hron-macos-x86_64/hron-macos-x86_64.tar.gz \
            dist/hron-macos-aarch64/hron-macos-aarch64.tar.gz \
            --clobber
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-crates:
    name: Publish to crates.io
    needs: create-release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: jdx/mise-action@v2
        with:
          install_args: rust

      - name: Publish hron
        run: |
          VERSION=$(cargo metadata --no-deps --format-version 1 | jq -r '.packages[] | select(.name == "hron") | .version')
          if cargo search hron --limit 100 | grep -q "^hron = \"$VERSION\""; then
            echo "hron $VERSION already on crates.io, skipping"
          else
            cargo publish --package hron
          fi
        working-directory: rust
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

      - name: Wait for crates.io index
        run: sleep 30

      - name: Publish hron-cli
        run: |
          VERSION=$(cargo metadata --no-deps --format-version 1 | jq -r '.packages[] | select(.name == "hron-cli") | .version')
          if cargo search hron-cli --limit 100 | grep -q "^hron-cli = \"$VERSION\""; then
            echo "hron-cli $VERSION already on crates.io, skipping"
          else
            cargo publish --package hron-cli
          fi
        working-directory: rust
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

  publish-wasm:
    name: Publish hron-wasm to npm
    needs: create-release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: jdx/mise-action@v2
        with:
          install_args: rust

      - uses: actions/setup-node@v4
        with:
          node-version: 24
          registry-url: https://registry.npmjs.org

      - name: Install wasm-pack
        run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

      - name: Build WASM package
        run: wasm-pack build --release
        working-directory: rust/wasm

      - name: Patch entry point for Cloudflare Workers compatibility
        run: cp rust/wasm/hron_wasm_entry.js rust/wasm/pkg/hron_wasm.js

      - name: Publish to npm
        run: |
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          if npm view hron-wasm@"$PACKAGE_VERSION" version > /dev/null 2>&1; then
            echo "hron-wasm $PACKAGE_VERSION already on npm, skipping"
          else
            npm publish --access public --provenance
          fi
        working-directory: rust/wasm/pkg

  publish-ts:
    name: Publish hron-ts to npm
    needs: create-release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 24
          registry-url: https://registry.npmjs.org

      - uses: jdx/mise-action@v2
        with:
          install_args: pnpm

      - name: Install and build
        run: pnpm install --frozen-lockfile && pnpm build
        working-directory: ts

      - name: Publish to npm
        run: |
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          if npm view hron-ts@"$PACKAGE_VERSION" version > /dev/null 2>&1; then
            echo "hron-ts $PACKAGE_VERSION already on npm, skipping"
          else
            pnpm publish --access public --no-git-checks --provenance
          fi
        working-directory: ts

  publish-dart:
    name: Publish to pub.dev
    needs: create-release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # setup-dart needed for pub.dev OIDC authentication
      - uses: dart-lang/setup-dart@v1
        with:
          sdk: stable

      - name: Publish to pub.dev
        run: |
          PACKAGE_VERSION=$(grep '^version:' pubspec.yaml | awk '{print $2}')
          if curl -sf "https://pub.dev/api/packages/hron/versions/$PACKAGE_VERSION" > /dev/null 2>&1; then
            echo "hron $PACKAGE_VERSION already on pub.dev, skipping"
          else
            dart pub publish --force
          fi
        working-directory: dart

  publish-python:
    name: Publish to PyPI
    needs: create-release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: astral-sh/setup-uv@v6

      - name: Build
        run: cd python && uv build

      - name: Publish to PyPI
        run: |
          VERSION=$(python3 -c "import tomllib; print(tomllib.load(open('python/pyproject.toml','rb'))['project']['version'])")
          if curl -sf "https://pypi.org/pypi/hron/$VERSION/json" > /dev/null 2>&1; then
            echo "hron $VERSION already on PyPI, skipping"
          else
            cd python && uv publish
          fi

  publish-go:
    name: Index on pkg.go.dev
    needs: create-release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Trigger Go proxy indexing
        run: |
          VERSION=$(cat VERSION)
          echo "Triggering pkg.go.dev indexing for v${VERSION}..."
          # Request the module version from proxy.golang.org to trigger indexing
          # This may fail initially if the tag hasn't propagated yet, so we retry
          for i in 1 2 3 4 5; do
            if curl -sfL "https://proxy.golang.org/github.com/prasrvenkat/hron/go/@v/v${VERSION}.info"; then
              echo "Go module v${VERSION} indexed successfully"
              exit 0
            fi
            echo "Attempt $i failed, waiting 30s..."
            sleep 30
          done
          echo "Warning: Go proxy indexing may still be propagating"

  publish-java:
    name: Publish to Maven Central
    needs: create-release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '25'
          server-id: central
          server-username: MAVEN_USERNAME
          server-password: MAVEN_PASSWORD
          gpg-private-key: ${{ secrets.GPG_PRIVATE_KEY }}
          gpg-passphrase: GPG_PASSPHRASE

      - name: Publish to Maven Central
        run: |
          VERSION=$(mvn -f java/pom.xml help:evaluate -Dexpression=project.version -q -DforceStdout)
          if curl -sf "https://repo1.maven.org/maven2/io/hron/hron/${VERSION}/hron-${VERSION}.pom" > /dev/null 2>&1; then
            echo "hron $VERSION already on Maven Central, skipping"
          else
            cd java && mvn deploy -P release
          fi
        env:
          MAVEN_USERNAME: ${{ secrets.MAVEN_CENTRAL_USERNAME }}
          MAVEN_PASSWORD: ${{ secrets.MAVEN_CENTRAL_PASSWORD }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}

  publish-csharp:
    name: Publish to NuGet
    needs: create-release
    runs-on: ubuntu-latest
    permissions:
      id-token: write  # Required for OIDC
    steps:
      - uses: actions/checkout@v4

      - uses: jdx/mise-action@v2
        with:
          install_args: dotnet

      - name: Build and pack
        run: dotnet pack csharp/Hron/Hron.csproj -c Release

      - name: NuGet login (OIDC)
        id: nuget-login
        uses: NuGet/login@v1
        with:
          user: ${{ vars.NUGET_USER }}

      - name: Publish to NuGet
        run: |
          VERSION=$(grep '<Version>' csharp/Hron/Hron.csproj | sed 's/.*<Version>\(.*\)<\/Version>.*/\1/')
          if curl -sf "https://api.nuget.org/v3-flatcontainer/hron/$VERSION/hron.nuspec" > /dev/null 2>&1; then
            echo "Hron $VERSION already on NuGet, skipping"
          else
            dotnet nuget push csharp/Hron/bin/Release/*.nupkg \
              --source https://api.nuget.org/v3/index.json \
              --api-key ${{ steps.nuget-login.outputs.NUGET_API_KEY }}
          fi

  publish-release:
    name: Publish Release
    needs: [version, upload-assets, publish-crates, publish-wasm, publish-ts, publish-dart, publish-python, publish-go, publish-java, publish-csharp]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Un-draft release
        run: gh release edit "v${{ needs.version.outputs.version }}" --draft=false
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
