name: Release

on:
  workflow_dispatch:

permissions:
  contents: write
  id-token: write

concurrency:
  group: release
  cancel-in-progress: false

jobs:
  version:
    name: Read Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: echo "version=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

  create-release:
    name: Create Draft Release
    needs: version
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Create draft release (idempotent)
        run: |
          if gh release view "v${{ needs.version.outputs.version }}" >/dev/null 2>&1; then
            echo "Release v${{ needs.version.outputs.version }} already exists, skipping"
          else
            gh release create "v${{ needs.version.outputs.version }}" \
              --draft \
              --generate-notes \
              --title "v${{ needs.version.outputs.version }}"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-binaries:
    name: Build (${{ matrix.target }})
    needs: create-release
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            runner: ubuntu-latest
            artifact: hron-linux-x86_64
          - target: x86_64-apple-darwin
            runner: macos-latest
            artifact: hron-macos-x86_64
          - target: aarch64-apple-darwin
            runner: macos-latest
            artifact: hron-macos-aarch64
    steps:
      - uses: actions/checkout@v4

      - uses: jdx/mise-action@v2
        with:
          install_args: rust

      - name: Add target
        run: rustup target add ${{ matrix.target }}

      - name: Build release binary
        run: cargo build --release --package hron-cli --target ${{ matrix.target }}
        working-directory: rust

      - name: Package artifact
        run: |
          mkdir staging
          cp rust/target/${{ matrix.target }}/release/hron staging/
          tar -czf ${{ matrix.artifact }}.tar.gz -C staging hron

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: ${{ matrix.artifact }}.tar.gz

  upload-assets:
    name: Upload Release Assets
    needs: [version, build-binaries]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Upload assets to release
        run: |
          gh release upload "v${{ needs.version.outputs.version }}" \
            dist/hron-linux-x86_64/hron-linux-x86_64.tar.gz \
            dist/hron-macos-x86_64/hron-macos-x86_64.tar.gz \
            dist/hron-macos-aarch64/hron-macos-aarch64.tar.gz \
            || echo "Assets already uploaded, skipping"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-crates:
    name: Publish to crates.io
    needs: create-release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: jdx/mise-action@v2
        with:
          install_args: rust

      - name: Publish hron
        run: cargo publish --package hron || echo "Already published, skipping"
        working-directory: rust
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

      - name: Wait for crates.io index
        run: sleep 30

      - name: Publish hron-cli
        run: cargo publish --package hron-cli || echo "Already published, skipping"
        working-directory: rust
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

  publish-wasm:
    name: Publish hron-wasm to npm
    needs: create-release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: jdx/mise-action@v2
        with:
          install_args: rust

      - uses: actions/setup-node@v4
        with:
          node-version: 24
          registry-url: https://registry.npmjs.org

      - name: Install wasm-pack
        run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

      - name: Build WASM package
        run: wasm-pack build --release
        working-directory: rust/wasm

      - name: Publish to npm
        run: npm publish --access public --provenance || echo "Already published, skipping"
        working-directory: rust/wasm/pkg

  publish-ts:
    name: Publish hron-ts to npm
    needs: create-release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 9

      - uses: actions/setup-node@v4
        with:
          node-version: 24
          registry-url: https://registry.npmjs.org

      - name: Build and publish
        run: pnpm install --frozen-lockfile && pnpm build && (pnpm publish --access public --no-git-checks --provenance || echo "Already published, skipping")
        working-directory: ts

  publish-dart:
    name: Publish to pub.dev
    needs: create-release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: dart-lang/setup-dart@v1
        with:
          sdk: stable

      - name: Publish to pub.dev
        run: dart pub publish --force || echo "Already published, skipping"
        working-directory: dart

  publish-release:
    name: Publish Release
    needs: [version, upload-assets, publish-crates, publish-wasm, publish-ts, publish-dart]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Un-draft release
        run: gh release edit "v${{ needs.version.outputs.version }}" --draft=false
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
